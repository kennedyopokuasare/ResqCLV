DROP VIEW IF EXISTS CUSTOMER_COHORT;

CREATE VIEW CUSTOMER_COHORT
AS
    WITH FIRSTORDERDATES AS (
        SELECT 
            USERID, 
            strftime('%Y-%m-01', MIN(DATE(CREATEDAT)))  AS COHORT_DATE
        FROM ORDERS
        GROUP BY USERID
    ),
    AT_LEAST_ONE_ORDER_PER_MONTH AS (
        SELECT 
            USERID, 
            MAX(CREATEDAT) AS PURCHASE_DATE
        FROM ORDERS
        GROUP BY USERID, strftime('%Y-%m-01', CREATEDAT)
    )

    SELECT 
        O.USERID, 
        FOD.COHORT_DATE,
        O.PURCHASE_DATE, 
        ((strftime('%Y', O.PURCHASE_DATE) - strftime('%Y', FOD.COHORT_DATE)) * 12) + 
        (strftime('%m', O.PURCHASE_DATE) - strftime('%m', FOD.COHORT_DATE)) AS MONTHS_SINCE_FIRST_PURCHASE
    FROM AT_LEAST_ONE_ORDER_PER_MONTH O
    LEFT JOIN FIRSTORDERDATES FOD ON O.USERID = FOD.USERID
    ORDER BY FOD.COHORT_DATE, O.USERID, O.PURCHASE_DATE;
